using System.Text;
using CodeChops.ImplementationDiscovery.SourceGeneration.Entities;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;

namespace CodeChops.ImplementationDiscovery.SourceGeneration.SourceBuilders;

public static class ImplementationIdSourceBuilder
{
    /// <summary>
    /// Creates a partial record of the enum definition which includes the discovered enum members. It also generates an extension class for the explicit enum definitions.
    /// </summary>
    public static void CreateSource(SourceProductionContext context, IEnumerable<DiscoveredEnumMember> allDiscoveredMembers, Dictionary<string, EnumDefinition> enumDefinitionsByIdentifier)
    {
        if (enumDefinitionsByIdentifier.Count == 0) return;

        // Get the discovered members and their definition.
        // Exclude the members that have no definition, or the members that are discovered while their definition doesn't allow it.
        var relevantDiscoveredMembersByDefinitions = allDiscoveredMembers
            .GroupBy(member => enumDefinitionsByIdentifier.TryGetValue(member.EnumIdentifier, out var definition) ? definition : null)
            .Where(grouping => grouping.Key is not null)
            .ToDictionary(grouping => grouping.Key, grouping => grouping.Where(member => grouping.Key!.DiscoverabilityMode == member.DiscoverabilityMode));
        
        foreach (var discoveredMembersByDefinition in relevantDiscoveredMembersByDefinitions)
        {
            var definition = discoveredMembersByDefinition.Key;
            var members = discoveredMembersByDefinition.Value.ToList();

            CreateStaticDiscoveredTypeIdFiles(context, definition!, members);
        }
    }
    
    private static void CreateStaticDiscoveredTypeIdFiles(SourceProductionContext context, EnumDefinition definition, IEnumerable<DiscoveredEnumMember> relevantDiscoveredMembers)
    {
        if (definition.DiscoverabilityMode != DiscoverabilityMode.Implementation || !definition.GenerateIdsForImplementations) return;

        var partialMembers = relevantDiscoveredMembers.Where(m => m.IsPartial);
		
        foreach (var member in partialMembers)
        {
            var code = new StringBuilder();

            // Create the whole source.
            code.Append($@"// <auto-generated />
#nullable enable
#pragma warning disable CS0109

using System;
using CodeChops.Identities;

{(member.Namespace is null ? null : $"namespace {member.Namespace};")}
");
			
            code.AppendLine($@"
{member.Definition} {member.Name} : IHasStaticTypeId<Id<string>>, IHasTypeId<Id<string>>
{{
	public static new Id<string> StaticTypeId {{ get; }} = new Id<string>(""{member.Name}"");
	public new IId GetTypeId() => StaticTypeId;
    public new Id<string> TypeId {{ get; }} = StaticTypeId;
}}

#nullable restore
");
			
            var typeIdFileName = FileNameHelpers.GetValidFileName($"{member.Namespace}.{member.Name}.g.cs");
            context.AddSource(typeIdFileName, SourceText.From(code.ToString(), Encoding.UTF8));
        }
    }

}